# 发送逻辑优化说明

## 概述

媒体通知 Webhook 插件现在支持智能发送策略，根据平台兼容性和配置自动选择最合适的发送方式。

## 发送策略

### 1. 智能发送逻辑

插件会根据以下条件自动选择发送方式：

```
消息数量 < batch_min_size
    ↓
直接单独发送

消息数量 ≥ batch_min_size
    ↓
检查 force_individual_send 配置
    ↓
是 → 强制单独发送
否 → 检查平台兼容性
    ↓
支持合并转发 → 使用合并转发
不支持合并转发 → 回退到单独发送
```

### 2. 平台兼容性

#### 支持合并转发的平台
- **aiocqhttp** - OneBot V11 标准，完全支持 Node 组件和合并转发

#### 不支持合并转发的平台
- **telegram** - 不支持 QQ 风格的合并转发
- **gewechat** - 微信个人号，不支持合并转发
- **qqofficial** - QQ 官方接口，不支持合并转发
- **lark** - 飞书，不支持合并转发
- **dingtalk** - 钉钉，不支持合并转发
- **discord** - Discord，不支持合并转发
- **wecom** - 企业微信，不支持合并转发

## 配置选项

### batch_min_size
- **描述**: 触发合并转发的最小消息数
- **默认值**: 3
- **说明**: 当队列中的消息数量达到此值时，才考虑使用合并转发

### platform_name
- **描述**: 消息平台名称
- **默认值**: "aiocqhttp"
- **说明**: 用于确定平台兼容性和发送策略

### force_individual_send
- **描述**: 强制单独发送
- **默认值**: false
- **说明**: 启用后，即使达到批量发送条件也会逐个发送消息

## 发送方式对比

### 合并转发 (Forward Messages)
**适用平台**: aiocqhttp

**优点**:
- 消息整洁，多条消息合并为一个转发卡片
- 减少群聊刷屏
- 保持消息的逻辑关联性

**缺点**:
- 平台兼容性有限
- 需要额外的 Node 组件支持

**示例效果**:
```
[合并转发] 媒体通知 (3条消息)
├─ 📺 新单集上线 - 剧集A S01E01
├─ 📺 新单集上线 - 剧集B S01E02  
└─ 📺 新单集上线 - 剧集C S01E03
```

### 单独发送 (Individual Messages)
**适用平台**: 所有平台

**优点**:
- 兼容性最好，支持所有平台
- 消息直观，每条消息独立显示
- 实现简单，稳定性高

**缺点**:
- 多条消息可能造成刷屏
- 消息间缺乏逻辑关联

**示例效果**:
```
📺 新单集上线 - 剧集A S01E01
📺 新单集上线 - 剧集B S01E02
📺 新单集上线 - 剧集C S01E03
```

## 使用建议

### 推荐配置

#### QQ 群 (aiocqhttp)
```json
{
  "platform_name": "aiocqhttp",
  "batch_min_size": 3,
  "force_individual_send": false
}
```
- 利用合并转发功能，减少刷屏

#### Telegram 群
```json
{
  "platform_name": "telegram", 
  "batch_min_size": 5,
  "force_individual_send": false
}
```
- 自动使用单独发送，适当提高阈值减少频繁发送

#### 微信群 (gewechat)
```json
{
  "platform_name": "gewechat",
  "batch_min_size": 2,
  "force_individual_send": false  
}
```
- 较低的阈值，及时发送通知

### 特殊场景

#### 测试环境
```json
{
  "force_individual_send": true
}
```
- 强制单独发送，便于调试和测试

#### 高频通知
```json
{
  "batch_min_size": 1,
  "force_individual_send": true
}
```
- 立即发送每条消息，不进行批量处理

## 状态监控

使用 `/webhook_status` 命令查看当前发送策略：

```
📊 Media Webhook 状态
🌐 服务地址: http://localhost:60071/media-webhook
🎯 目标群组: 123456789
🔗 消息平台: aiocqhttp
📤 发送策略: 智能发送（支持合并转发）
🔀 合并转发支持: ✅

📋 队列消息数: 2
🗂️ 缓存请求数: 5
⚙️ 批量发送阈值: 3
⏰ 处理间隔: 300秒
```

## 日志示例

### 智能发送 (aiocqhttp)
```
[INFO] 消息数量 3 达到批量发送阈值 3，使用单独发送
[INFO] 平台 aiocqhttp 支持合并转发，将 3 条消息合并发送
[INFO] 使用合并转发发送 3 条消息
[INFO] 成功发送 3 条合并转发消息
```

### 平台回退 (telegram)
```
[INFO] 消息数量 4 达到批量发送阈值 3，使用单独发送
[INFO] 平台 telegram 不支持合并转发，将 4 条消息逐个发送
[INFO] 逐个发送 4 条消息
[INFO] 成功逐个发送 4 条消息
```

### 强制单独发送
```
[INFO] 配置强制单独发送，将 5 条消息逐个发送
[INFO] 逐个发送 5 条消息
[INFO] 成功逐个发送 5 条消息
```

## 故障排除

### 合并转发失败
如果合并转发出现问题，插件会自动记录错误并可能回退到单独发送模式。

### 平台不兼容
插件会自动检测平台兼容性，不支持合并转发的平台会自动使用单独发送。

### 配置错误
检查 `platform_name` 配置是否与实际使用的平台匹配。
